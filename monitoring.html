<!DOCTYPE html>
<html lang="ko">
  <head>
    <script>
      // 1. ëª¨ë“  Service Worker ì œê±°
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker
          .getRegistrations()
          .then(function (registrations) {
            for (let registration of registrations) {
              registration.unregister();
            }
          });
      }

      // 2. ëª¨ë“  ìºì‹œ ì‚­ì œ
      if ('caches' in window) {
        caches.keys().then(function (names) {
          for (let name of names) {
            caches.delete(name);
          }
        });
      }

      // 3. ë²„ì „ ê¸°ë°˜ ê°•ì œ ìƒˆë¡œê³ ì¹¨
      (function () {
        const FORCE_VERSION = '20250820-3';
        const STORAGE_KEY = 'force_refresh_version';
        const savedVersion = sessionStorage.getItem(STORAGE_KEY);

        if (savedVersion !== FORCE_VERSION) {
          sessionStorage.setItem(STORAGE_KEY, FORCE_VERSION);

          // URLì— íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€í•˜ì—¬ ì™„ì „íˆ ìƒˆë¡œìš´ ìš”ì²­ìœ¼ë¡œ ì²˜ë¦¬
          const timestamp = new Date().getTime();
          const separator = window.location.search ? '&' : '?';
          const newUrl = window.location.href + separator + 't=' + timestamp;

          // í•˜ë“œ ë¦¬ë¡œë“œ
          window.location.replace(newUrl);
        }
      })();
    </script>
    <script>
      // ì¹´ì¹´ì˜¤í†¡ ì¸ì•± ë¸Œë¼ìš°ì € ê°ì§€
      function isKakaoTalk() {
        const ua = navigator.userAgent.toLowerCase();
        return ua.includes('kakaotalk');
      }

      if (isKakaoTalk()) {
        // ì¹´í†¡ì—ì„œ ì—´ë¦° ê²½ìš° ë¬´ì¡°ê±´ ìƒˆ ë²„ì „ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        const timestamp = new Date().getTime();
        const newUrl = window.location.pathname + '?kakao=' + timestamp;

        if (!window.location.search.includes('kakao=')) {
          window.location.replace(newUrl);
        }
      }
    </script>

    <!-- ìµœìš°ì„  ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
      // ë²„ì „ ì²´í¬ ë° ê°•ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      (function () {
        const CURRENT_VERSION = '20250820';
        const urlParams = new URLSearchParams(window.location.search);
        const urlVersion = urlParams.get('v');

        // ë²„ì „ íŒŒë¼ë¯¸í„°ê°€ ì—†ê±°ë‚˜ ì˜¤ë˜ëœ ê²½ìš° ê°•ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        if (!urlVersion || urlVersion !== CURRENT_VERSION) {
          urlParams.set('v', CURRENT_VERSION);
          const newUrl = window.location.pathname + '?' + urlParams.toString();
          window.location.replace(newUrl);
          return;
        }
      })();
    </script>

    <!-- ìºì‹œ ë°©ì§€ ë©”íƒ€ íƒœê·¸ -->
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>VIP ì„¤ëª…íšŒ ì˜ˆì•½ ëª¨ë‹ˆí„°ë§ - i.study</title>

    <!-- Supabase í´ë¼ì´ì–¸íŠ¸ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- CSS íŒŒì¼ -->
    <link rel="stylesheet" href="assets/css/monitoring-v2.css?v=20250820" />

    <!-- íŒŒë¹„ì½˜ -->
    <link rel="icon" href="data:," />
  </head>
  <body>
    <!-- í—¤ë” -->
    <header class="header">
      <div class="header-content">
        <div class="header-left">
          <h1 class="header-title">VIP ì„¤ëª…íšŒ ëª¨ë‹ˆí„°ë§</h1>
          <span class="connection-status" id="connectionStatus">
            <span class="status-dot connected"></span>
            <span class="status-text">ì‹¤ì‹œê°„</span>
          </span>
        </div>
        <div class="header-right">
          <button class="icon-btn" onclick="refreshData()" title="ìƒˆë¡œê³ ì¹¨">
            <span class="refresh-icon">â†»</span>
          </button>
        </div>
      </div>
    </header>

    <main class="main-container">
      <!-- í†µê³„ ì„¹ì…˜ -->
      <section class="stats-section">
        <!-- ì „ì²´ í†µê³„ ë¯¸ë‹ˆ ì¹´ë“œ -->
        <div class="total-stats">
          <div class="mini-stat-card">
            <span class="mini-stat-value" id="totalAll">0</span>
            <span class="mini-stat-label">ì „ì²´</span>
          </div>
          <div class="mini-stat-card success">
            <span class="mini-stat-value" id="totalAttended">0</span>
            <span class="mini-stat-label">ì°¸ì„</span>
          </div>
          <div class="mini-stat-card pending">
            <span class="mini-stat-value" id="totalPending">0</span>
            <span class="mini-stat-label">ëŒ€ê¸°</span>
          </div>
          <div class="mini-stat-card cancelled">
            <span class="mini-stat-value" id="totalCancelled">0</span>
            <span class="mini-stat-label">ì·¨ì†Œ</span>
          </div>
        </div>

        <!-- ì„¤ëª…íšŒë³„ í˜„í™© -->
        <div class="seminar-stats">
          <div class="section-header">
            <h2 class="section-title">ì„¤ëª…íšŒë³„ í˜„í™©</h2>
            <div class="view-toggle">
              <button
                class="toggle-btn active"
                onclick="toggleStatsView('chart')"
              >
                ì°¨íŠ¸
              </button>
              <button class="toggle-btn" onclick="toggleStatsView('list')">
                ë¦¬ìŠ¤íŠ¸
              </button>
            </div>
          </div>

          <!-- ì°¨íŠ¸ ë·° -->
          <div class="stats-view" id="chartView">
            <div class="seminar-cards" id="seminarCards">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>

          <!-- ë¦¬ìŠ¤íŠ¸ ë·° -->
          <div class="stats-view hidden" id="listView">
            <div class="seminar-list" id="seminarList">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>
        </div>
      </section>

      <!-- ê²€ìƒ‰/í•„í„° ì„¹ì…˜ -->
      <section class="filter-section">
        <div class="filter-header">
          <h2 class="section-title">ì˜ˆì•½ ëª©ë¡</h2>
          <div class="filter-actions">
            <button class="filter-toggle-btn" onclick="toggleFilters()">
              <span class="filter-icon">âš™</span>
              <span class="filter-text">í•„í„°</span>
            </button>
          </div>
        </div>

        <!-- í•„í„° íŒ¨ë„ -->
        <div class="filter-panel" id="filterPanel">
          <div class="filter-row">
            <div class="filter-group">
              <select class="filter-select" id="filterSeminar">
                <option value="">ì „ì²´ ì„¤ëª…íšŒ</option>
              </select>
            </div>
            <div class="filter-group">
              <select class="filter-select" id="filterStatus">
                <option value="">ì „ì²´ ìƒíƒœ</option>
                <option value="ì˜ˆì•½">ì˜ˆì•½</option>
                <option value="ì°¸ì„">ì°¸ì„</option>
                <option value="ë¶ˆì°¸">ë¶ˆì°¸</option>
                <option value="ì·¨ì†Œ">ì·¨ì†Œ</option>
                <option value="ëŒ€ê¸°">ëŒ€ê¸°ì˜ˆì•½</option>
              </select>
            </div>
            <div class="filter-group search-group">
              <input
                type="text"
                class="filter-input"
                id="searchStudent"
                placeholder="ğŸ” í•™ìƒëª… ê²€ìƒ‰"
              />
            </div>
            <div class="filter-group desktop-only">
              <input
                type="text"
                class="filter-input"
                id="searchPhone"
                placeholder="ì „í™”ë²ˆí˜¸"
              />
            </div>
            <div class="filter-group desktop-only">
              <input
                type="text"
                class="filter-input"
                id="searchSchool"
                placeholder="í•™êµëª…"
              />
            </div>
            <div class="filter-group filter-buttons">
              <button class="btn btn-primary" onclick="applyFilters()">
                ê²€ìƒ‰
              </button>
              <button class="btn btn-secondary" onclick="resetFilters()">
                ì´ˆê¸°í™”
              </button>
              <button
                class="btn btn-export desktop-only"
                onclick="exportToExcel()"
              >
                <span>ğŸ“¥</span> ì—‘ì…€
              </button>
            </div>
          </div>
        </div>

        <!-- ë¹ ë¥¸ í•„í„° (ëª¨ë°”ì¼) -->
        <div class="quick-filters mobile-only">
          <button class="quick-filter-btn active" onclick="quickFilter('all')">
            ì „ì²´
          </button>
          <button class="quick-filter-btn" onclick="quickFilter('reserved')">
            ì˜ˆì•½
          </button>
          <button class="quick-filter-btn" onclick="quickFilter('attended')">
            ì°¸ì„
          </button>
          <button class="quick-filter-btn" onclick="quickFilter('waitlist')">
            ëŒ€ê¸°
          </button>
        </div>
      </section>

      <!-- ì„ íƒ ì•¡ì…˜ ë°” -->
      <div class="selection-bar hidden" id="selectionBar">
        <div class="selection-info">
          <span id="selectedCount">0</span>ê°œ ì„ íƒ
        </div>
        <div class="selection-actions">
          <button class="action-btn success" onclick="bulkUpdate('ì°¸ì„')">
            ì°¸ì„
          </button>
          <button class="action-btn danger" onclick="bulkUpdate('ë¶ˆì°¸')">
            ë¶ˆì°¸
          </button>
          <button class="action-btn warning" onclick="bulkUpdate('ì·¨ì†Œ')">
            ì·¨ì†Œ
          </button>
          <button class="action-btn secondary" onclick="clearSelection()">
            í•´ì œ
          </button>
        </div>
      </div>

      <!-- ë°ì´í„° í…Œì´ë¸” ì„¹ì…˜ -->
      <section class="table-section">
        <!-- í…Œì´ë¸” ìƒë‹¨ ì»¨íŠ¸ë¡¤ ì¶”ê°€ -->
        <div class="table-controls">
          <div class="table-info">
            <span>ì „ì²´ <strong id="totalEntries">0</strong>ê°œ</span>
            <select id="entriesPerPage" onchange="changeEntriesPerPage()">
              <option value="20" selected>20ê°œì”© ë³´ê¸°</option>
              <option value="30">30ê°œì”© ë³´ê¸°</option>
              <option value="50">50ê°œì”© ë³´ê¸°</option>
              <option value="100">100ê°œì”© ë³´ê¸°</option>
            </select>
          </div>
          <div class="pagination" id="pagination">
            <button
              class="page-btn"
              onclick="goToFirstPage()"
              id="firstPageBtn"
            >
              â‰ª
            </button>
            <button class="page-btn" onclick="goToPrevPage()" id="prevPageBtn">
              ï¼œ
            </button>
            <div class="page-numbers" id="pageNumbers">
              <!-- ë™ì  ìƒì„± -->
            </div>
            <button class="page-btn" onclick="goToNextPage()" id="nextPageBtn">
              ï¼
            </button>
            <button class="page-btn" onclick="goToLastPage()" id="lastPageBtn">
              â‰«
            </button>
          </div>
        </div>

        <!-- PC í…Œì´ë¸” -->
        <div class="desktop-table desktop-only">
          <table class="data-table">
            <thead>
              <tr>
                <th class="checkbox-col">
                  <input
                    type="checkbox"
                    id="selectAll"
                    onchange="toggleSelectAll()"
                  />
                </th>
                <th class="number-col">ë²ˆí˜¸</th>
                <th class="reservation-col">ì˜ˆì•½ë²ˆí˜¸</th>
                <th class="seminar-col">ì„¤ëª…íšŒ</th>
                <th class="name-col">í•™ìƒëª…</th>
                <th class="phone-col">ì—°ë½ì²˜</th>
                <th class="school-col">í•™êµ</th>
                <th class="grade-col">í•™ë…„</th>
                <th class="math-col">ìˆ˜í•™ì„ í–‰</th>
                <th class="date-col">ì˜ˆì•½ì¼ì‹œ</th>
                <th class="status-col">ìƒíƒœ</th>
                <th class="action-col">ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="desktopTableBody">
              <!-- ë™ì  ìƒì„± -->
            </tbody>
          </table>
        </div>

        <!-- ëª¨ë°”ì¼ ë¦¬ìŠ¤íŠ¸ -->
        <div class="mobile-list mobile-only">
          <div class="mobile-controls">
            <span>ì „ì²´ <strong id="totalEntriesMobile">0</strong>ê°œ</span>
            <select id="entriesPerPageMobile" onchange="changeEntriesPerPage()">
              <option value="10" selected>10ê°œì”©</option>
              <option value="20">20ê°œì”©</option>
              <option value="30">30ê°œì”©</option>
            </select>
          </div>
          <div id="mobileList">
            <!-- ë™ì  ìƒì„± -->
          </div>
          <div class="mobile-pagination">
            <button onclick="goToPrevPage()">ì´ì „</button>
            <span id="mobilePageInfo">1 / 1</span>
            <button onclick="goToNextPage()">ë‹¤ìŒ</button>
          </div>
        </div>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div class="loading-state hidden" id="loadingState">
          <div class="loading-spinner"></div>
          <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- ë¹ˆ ìƒíƒœ -->
        <div class="empty-state hidden" id="emptyState">
          <div class="empty-icon">ğŸ“‹</div>
          <p>í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
      </section>

      <!-- ì „í™˜ìœ¨ ë¶„ì„ ì„¹ì…˜ -->
      <section class="stats-section funnel-section" style="margin-top: 24px">
        <div class="seminar-stats">
          <div class="section-header">
            <h2 class="section-title">ì „í™˜ìœ¨ ë¶„ì„</h2>
            <div class="funnel-period">
              <select id="funnelPeriod" onchange="updateFunnelPeriod()">
                <option value="today">ì˜¤ëŠ˜</option>
                <option value="week" selected>ìµœê·¼ 7ì¼</option>
                <option value="month">ìµœê·¼ 30ì¼</option>
                <option value="all">ì „ì²´</option>
              </select>
            </div>
          </div>

          <!-- ê°€ë¡œí˜• í¼ë„ -->
          <div class="funnel-container">
            <div class="funnel-flow">
              <div class="funnel-node">
                <div class="funnel-label">í˜ì´ì§€ ë°©ë¬¸</div>
                <div class="funnel-value" id="visitCount">-</div>
                <div class="funnel-percent">100%</div>
              </div>

              <div class="funnel-arrow">
                <div class="arrow-line"></div>
                <div class="arrow-rate" id="visitToSelectRate">50.0%</div>
              </div>

              <div class="funnel-node">
                <div class="funnel-label">ì„¤ëª…íšŒ ì„ íƒ</div>
                <div class="funnel-value" id="selectCount">-</div>
                <div class="funnel-percent" id="selectRate">50.0%</div>
              </div>

              <div class="funnel-arrow">
                <div class="arrow-line"></div>
                <div class="arrow-rate" id="selectToPhoneRate">40.0%</div>
              </div>

              <div class="funnel-node">
                <div class="funnel-label">ì •ë³´ ì…ë ¥</div>
                <div class="funnel-value" id="phoneCount">-</div>
                <div class="funnel-percent" id="phoneRate">20.0%</div>
              </div>

              <div class="funnel-arrow">
                <div class="arrow-line"></div>
                <div class="arrow-rate" id="phoneToReservationRate">50.0%</div>
              </div>

              <div class="funnel-node">
                <div class="funnel-label">ì˜ˆì•½ ì™„ë£Œ</div>
                <div class="funnel-value" id="reservationCount">-</div>
                <div class="funnel-percent" id="reservationRate">10.0%</div>
              </div>

              <div class="funnel-arrow">
                <div class="arrow-line"></div>
                <div class="arrow-rate" id="reservationToAttendanceRate">
                  0.0%
                </div>
              </div>

              <div class="funnel-node">
                <div class="funnel-label">ì„¤ëª…íšŒ ì°¸ì„</div>
                <div class="funnel-value" id="attendanceCount">-</div>
                <div class="funnel-percent" id="attendanceRate">0.0%</div>
              </div>

              <div class="funnel-arrow">
                <div class="arrow-line"></div>
                <div class="arrow-rate" id="attendanceToConsultingRate">0%</div>
              </div>

              <div class="funnel-node primary">
                <div class="funnel-label">ì»¨ì„¤íŒ… ì˜ˆì•½</div>
                <div class="funnel-value" id="consultingCount">-</div>
                <div class="funnel-percent" id="consultingRate">0.0%</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- í•µì‹¬ ì§€í‘œ ì¹´ë“œ -->
      <section class="stats-section funnel-section">
        <div class="total-stats">
          <div class="mini-stat-card">
            <span class="mini-stat-value" id="bookingConversion">10.0%</span>
            <span class="mini-stat-label">ì˜ˆì•½ ì „í™˜ìœ¨</span>
          </div>
          <div class="mini-stat-card">
            <span class="mini-stat-value" id="attendanceConversion">0.0%</span>
            <span class="mini-stat-label">ì°¸ì„ë¥ </span>
          </div>
          <div class="mini-stat-card">
            <span class="mini-stat-value" id="consultingConversion">0.0%</span>
            <span class="mini-stat-label">ì»¨ì„¤íŒ… ì „í™˜ìœ¨</span>
          </div>
          <div class="mini-stat-card success">
            <span class="mini-stat-value" id="finalConversion">0.00%</span>
            <span class="mini-stat-label">ìµœì¢… ì „í™˜ìœ¨</span>
          </div>
        </div>
      </section>

      <!-- ì‹¤ì‹œê°„ ì²´í¬ì¸ ì„¹ì…˜ -->
      <section class="stats-section">
        <div class="seminar-stats">
          <div class="section-header">
            <h2 class="section-title">ì‹¤ì‹œê°„ ì²´í¬ì¸</h2>
            <button class="btn btn-primary" onclick="openQRGenerator()">
              QR ì½”ë“œ ìƒì„±
            </button>
          </div>

          <div class="checkin-list" id="recentCheckins">
            <!-- ìµœê·¼ ì²´í¬ì¸ ëª©ë¡ -->
          </div>
        </div>
      </section>
    </main>

    <!-- ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
    <div class="dropdown-menu hidden" id="dropdownMenu">
      <button class="dropdown-item" onclick="handleDropdownAction('edit')">
        <span class="dropdown-icon">âœï¸</span>
        <span>ìˆ˜ì •</span>
      </button>
      <button class="dropdown-item" onclick="handleDropdownAction('attend')">
        <span class="dropdown-icon">âœ…</span>
        <span>ì°¸ì„ ì²˜ë¦¬</span>
      </button>
      <button class="dropdown-item" onclick="handleDropdownAction('absent')">
        <span class="dropdown-icon">âŒ</span>
        <span>ë¶ˆì°¸ ì²˜ë¦¬</span>
      </button>
      <button class="dropdown-item" onclick="handleDropdownAction('cancel')">
        <span class="dropdown-icon">ğŸš«</span>
        <span>ì·¨ì†Œ ì²˜ë¦¬</span>
      </button>
    </div>

    <!-- ëª¨ë°”ì¼ í”Œë¡œíŒ… ë²„íŠ¼ -->
    <div class="fab-container mobile-only">
      <button class="fab" onclick="toggleFabMenu()">
        <span class="fab-icon">+</span>
      </button>
      <div class="fab-menu hidden" id="fabMenu">
        <button class="fab-menu-item" onclick="exportToExcel()">
          <span>ğŸ“¥</span> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        </button>
        <button class="fab-menu-item" onclick="showBulkActions()">
          <span>âœ“</span> ì¼ê´„ ì„ íƒ
        </button>
      </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- í¸ì§‘ ëª¨ë‹¬ -->
    <div class="modal hidden" id="editModal">
      <div class="modal-backdrop" onclick="closeEditModal()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">ì˜ˆì•½ ì •ë³´ ìˆ˜ì •</h3>
          <button class="modal-close" onclick="closeEditModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="editId" />
            <div class="form-group">
              <label class="form-label">í•™ìƒëª…</label>
              <input
                type="text"
                class="form-input"
                id="editStudentName"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label">ì—°ë½ì²˜</label>
              <input type="text" class="form-input" id="editPhone" required />
            </div>
            <div class="form-group">
              <label class="form-label">í•™êµ</label>
              <input type="text" class="form-input" id="editSchool" required />
            </div>
            <div class="form-group">
              <label class="form-label">í•™ë…„</label>
              <select class="form-input" id="editGrade" required>
                <option value="ì´ˆ1">ì´ˆ1</option>
                <option value="ì´ˆ2">ì´ˆ2</option>
                <option value="ì´ˆ3">ì´ˆ3</option>
                <option value="ì´ˆ4">ì´ˆ4</option>
                <option value="ì´ˆ5">ì´ˆ5</option>
                <option value="ì´ˆ6">ì´ˆ6</option>
                <option value="ì¤‘1">ì¤‘1</option>
                <option value="ì¤‘2">ì¤‘2</option>
                <option value="ì¤‘3">ì¤‘3</option>
                <option value="ê³ 1">ê³ 1</option>
                <option value="ê³ 2">ê³ 2</option>
                <option value="ê³ 3">ê³ 3</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">ìˆ˜í•™ ì„ í–‰ì •ë„</label>
              <input type="text" class="form-input" id="editMathLevel" />
            </div>
            <div class="form-group">
              <label class="form-label">ë©”ëª¨</label>
              <textarea class="form-input" id="editNotes" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeEditModal()">
            ì·¨ì†Œ
          </button>
          <button class="btn btn-primary" onclick="saveEdit()">ì €ì¥</button>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="assets/js/monitoring-v2.js"></script>
  </body>
</html>
