<!DOCTYPE html>
<html lang="ko">
  <head>
    <!-- 최우선 실행: 카카오톡 감지 및 리다이렉트 -->
    <script>
      (function () {
        // 카카오톡 인앱 브라우저 감지
        const isKakao = /KAKAOTALK/i.test(navigator.userAgent);

        if (isKakao) {
          // 현재 URL 파싱
          const url = new URL(window.location.href);
          const currentTime = new Date().getTime();

          // 't' 파라미터가 없거나 1분 이상 지난 경우 리다이렉트
          const existingTime = url.searchParams.get('t');
          if (!existingTime || currentTime - parseInt(existingTime) > 60000) {
            // 강제로 새 URL로 리다이렉트
            url.searchParams.set('t', currentTime);
            url.searchParams.set('v', '20250820');

            // 즉시 리다이렉트 (현재 페이지 렌더링 방지)
            document.write('<html><body>Loading...</body></html>');
            window.location.replace(url.toString());
            throw new Error('Redirecting...'); // 스크립트 실행 중지
          }
        }

        // 일반 브라우저도 버전 체크
        const CURRENT_VERSION = '20250820';
        const urlParams = new URLSearchParams(window.location.search);
        const urlVersion = urlParams.get('v');

        if (!urlVersion || urlVersion !== CURRENT_VERSION) {
          urlParams.set('v', CURRENT_VERSION);
          urlParams.set('t', new Date().getTime());
          const newUrl = window.location.pathname + '?' + urlParams.toString();
          window.location.replace(newUrl);
          throw new Error('Version update...');
        }
      })();
    </script>

    <!-- 캐시 방지 메타 태그 (최대한 강력하게) -->
    <meta charset="UTF-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate, post-check=0, pre-check=0, max-age=0, s-maxage=0"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="-1" />
    <meta http-equiv="Clear-Site-Data" content="cache" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>i.study VIP 학부모 설명회 예약</title>

    <!-- 동적 버전 관리 CSS -->
    <script>
      document.write(
        '<link rel="stylesheet" href="assets/css/index.css?v=' +
          new Date().getTime() +
          '" />'
      );
    </script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link rel="icon" href="data:," />

    <!-- 추가 캐시 방지 -->
    <script>
      // Service Worker 제거
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker
          .getRegistrations()
          .then(function (registrations) {
            for (let registration of registrations) {
              registration.unregister();
            }
          });
      }

      // 모든 캐시 삭제
      if ('caches' in window) {
        caches.keys().then(function (names) {
          for (let name of names) {
            caches.delete(name);
          }
        });
      }

      // localStorage 버전 체크
      const STORAGE_VERSION = '20250820-v2';
      const savedVersion = localStorage.getItem('app_version');
      if (savedVersion !== STORAGE_VERSION) {
        localStorage.clear();
        sessionStorage.clear();
        localStorage.setItem('app_version', STORAGE_VERSION);
      }
    </script>
  </head>
  <body>
    <div class="container">
      <!-- 홈 화면 -->
      <div id="home" class="card">
        <!-- 로고와 타이틀 영역 -->
        <div class="title-area">
          <img src="assets/images/istudy-logo.png" alt="i.study" class="logo" />
          <h1>VIP 학부모 설명회</h1>
        </div>

        <h2>설명회 참석 예약 시스템</h2>

        <p class="select-guide">참석하실 설명회를 선택해주세요</p>

        <!-- 설명회 선택 영역 (동적으로 추가됨) -->
        <div id="seminarSelectionArea">
          <!-- 초기 로딩 표시 -->
          <div class="initial-loading">
            <div class="spinner"></div>
            <p>설명회 정보를 불러오는 중입니다...</p>
            <p style="font-size: 12px; color: #999; margin-top: 5px">
              잠시만 기다려주세요
            </p>
          </div>
        </div>

        <!-- 마감 안내 (기본적으로 숨김) -->
        <div id="fullNotice" class="full-notice hidden">
          <h3>🔥 조기 마감되었습니다!</h3>
          <p>
            높은 관심으로 인해 정원이 조기 마감되었습니다.<br />지금
            <strong>대기예약</strong>을 신청하시면<br />취소자 발생 시 우선
            연락드립니다.
          </p>
        </div>

        <div class="info-box" id="defaultInfoBox">
          <p><strong>설명회를 선택해주세요</strong></p>
          <p>
            아래에서 참석하실 설명회를 선택하시면 상세 정보를 확인하실 수
            있습니다.
          </p>
        </div>

        <div class="btn-group">
          <button
            class="btn btn-primary"
            id="reserveBtn"
            onclick="proceedToReservation()"
            disabled
          >
            설명회를 먼저 선택해주세요
          </button>
          <button class="btn btn-secondary" onclick="showScreen('check')">
            예약 확인하기
          </button>
        </div>
      </div>

      <!-- 전화번호 입력 -->
      <div id="phone" class="card hidden">
        <button class="btn btn-back" onclick="showScreen('home')">
          ← 뒤로
        </button>
        <h2 id="phoneTitle">설명회 예약하기</h2>
        <p style="margin-bottom: 20px; color: #666">
          학부모님 연락처를 입력해주세요.
        </p>

        <form id="phoneForm">
          <div class="form-group">
            <label>학부모 연락처</label>
            <input
              type="tel"
              id="initialPhone"
              placeholder="010-0000-0000"
              required
            />
          </div>

          <button
            type="button"
            class="btn btn-secondary"
            onclick="checkPreviousInfo()"
            style="margin-bottom: 15px"
          >
            이전 정보 불러오기
          </button>

          <button type="submit" class="btn btn-primary">다음</button>
        </form>
      </div>

      <!-- 개인정보 입력 -->
      <div id="info" class="card hidden">
        <button class="btn btn-back" onclick="goBackFromInfo()">← 뒤로</button>
        <h2 id="infoTitle">설명회 예약하기</h2>
        <p style="margin-bottom: 20px; color: #666">
          참석자 정보를 입력해주세요.
        </p>

        <div id="infoLoadedNotice" class="info-loaded-notice hidden">
          <span>✅</span>
          <span
            >학교와 학년 정보를 불러왔습니다. 나머지 정보는 직접
            입력해주세요.</span
          >
        </div>

        <form id="infoForm">
          <div class="form-group">
            <label>학생명 <span class="required-mark">*</span></label>
            <input type="text" id="studentName" required minlength="2" />
            <div id="studentNameHint" class="placeholder-hint hidden"></div>
          </div>

          <div class="form-group">
            <label>학부모 연락처 <span class="required-mark">*</span></label>
            <input
              type="tel"
              id="parentPhone"
              placeholder="010-0000-0000"
              required
              readonly
            />
          </div>

          <div class="form-group">
            <label>학교 <span class="required-mark">*</span></label>
            <input type="text" id="school" required minlength="2" />
          </div>

          <div class="form-group">
            <label>학년 <span class="required-mark">*</span></label>
            <select id="grade" required>
              <option value="">선택하세요</option>
              <option value="초1">초등학교 1학년</option>
              <option value="초2">초등학교 2학년</option>
              <option value="초3">초등학교 3학년</option>
              <option value="초4">초등학교 4학년</option>
              <option value="초5">초등학교 5학년</option>
              <option value="초6">초등학교 6학년</option>
              <option value="중1">중학교 1학년</option>
              <option value="중2">중학교 2학년</option>
              <option value="중3">중학교 3학년</option>
              <option value="고1">고등학교 1학년</option>
              <option value="고2">고등학교 2학년</option>
              <option value="고3">고등학교 3학년</option>
            </select>
          </div>

          <div class="form-group">
            <label>수학 선행정도 <span class="required-mark">*</span></label>
            <input
              type="text"
              id="mathLevel"
              placeholder="예: 중2 과정 진행중"
              required
              minlength="2"
            />
          </div>

          <div class="form-group">
            <label
              >비밀번호 (숫자 6자리) <span class="required-mark">*</span></label
            >
            <input
              type="password"
              id="password"
              class="password-input"
              placeholder="000000"
              pattern="[0-9]{6}"
              maxlength="6"
              required
            />
            <div class="password-hint">
              예약 확인/취소 시 필요합니다. 꼭 기억해주세요!
            </div>
          </div>

          <!-- 대기예약 체크박스 (숨김 상태로 시작) -->
          <div id="waitlistSection" class="waitlist-checkbox hidden">
            <input type="checkbox" id="waitlistConsent" />
            <label for="waitlistConsent">
              <strong>[대기예약 동의]</strong> 취소자 발생 시 우선으로
              연락받기를 원합니다.<br />
              <small style="color: #666"
                >* 대기 순번대로 개별 연락드립니다.</small
              >
            </label>
          </div>

          <!-- 개인정보 수집 동의 섹션 -->
          <div class="privacy-section">
            <div class="privacy-title">개인정보 수집 및 이용 동의</div>
            <div class="privacy-content">
              <h4>1. 개인정보 수집 목적</h4>
              <p>- 설명회 참석 신청 및 관리</p>
              <p>- 설명회 관련 안내 사항 전달</p>
              <p>- 설명회 참석 후 개별 컨설팅 예약 관리</p>
              <p>- 대기예약 신청 시 취소자 발생 안내</p>

              <h4>2. 수집하는 개인정보 항목</h4>
              <table>
                <tr>
                  <th>필수항목</th>
                  <td>학생명, 학부모 연락처, 학교, 학년, 수학 선행정도</td>
                </tr>
              </table>

              <h4>3. 개인정보 보유 및 이용기간</h4>
              <p>- 수집일로부터 1년간 보유</p>
              <p>
                - 관계 법령에 따라 보존할 필요가 있는 경우 해당 법령에서 정한
                기간 동안 보유
              </p>

              <h4>4. 개인정보 제3자 제공</h4>
              <p>
                - 원칙적으로 이용자의 개인정보를 제3자에게 제공하지 않습니다.
              </p>
              <p>
                - 단, 이용자의 동의가 있거나 법령에 의한 경우는 예외로 합니다.
              </p>

              <h4>5. 동의 거부권 및 불이익</h4>
              <p>
                - 개인정보 수집 및 이용에 대한 동의를 거부할 권리가 있습니다.
              </p>
              <p>- 다만, 동의를 거부할 경우 설명회 예약이 불가능합니다.</p>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="privacyConsent" required />
              <label for="privacyConsent" class="checkbox-label">
                <strong>[필수]</strong> 위 개인정보 수집 및 이용에 동의합니다.
              </label>
            </div>

            <div class="privacy-notice">
              ※ 만 14세 미만 아동의 경우 법정대리인의 동의가 필요합니다.
            </div>
          </div>

          <div class="security-notice">
            ⚠️ 비밀번호는 예약 확인 및 취소 시 반드시 필요합니다. 분실 시 복구가
            어려우니 안전한 곳에 기록해두세요.
          </div>

          <button
            type="submit"
            class="btn btn-primary"
            id="submitBtn"
            style="margin-top: 20px"
          >
            예약 확정
          </button>
        </form>
      </div>

      <!-- 예약 완료 -->
      <div id="complete" class="card hidden">
        <div class="success-icon">✅</div>
        <h2 id="completeTitle">예약이 완료되었습니다</h2>
        <p
          style="text-align: center; margin-bottom: 20px; color: #666"
          id="completeSubtitle"
        >
          설명회에서 뵙겠습니다.
        </p>

        <div class="reservation-info" id="completionInfo"></div>

        <div class="info-box" id="completeInfoBox">
          <p><strong>안내사항</strong></p>
          <ul>
            <li>설명회 시작 10분 전까지 도착해주세요.</li>
            <li>주차공간이 협소하니 대중교통 이용을 권장합니다.</li>
            <li>설명회 참석 후 개별 컨설팅 예약이 가능합니다.</li>
            <li>설명회는 90분간 진행됩니다.</li>
          </ul>
        </div>

        <button class="btn btn-primary" onclick="showScreen('home')">
          홈으로 돌아가기
        </button>
      </div>

      <!-- 예약 확인 -->
      <div id="check" class="card hidden">
        <button class="btn btn-back" onclick="showScreen('home')">
          ← 뒤로
        </button>
        <h2>예약 확인하기</h2>
        <p style="margin-bottom: 20px; color: #666">
          예약 정보를 입력해주세요.
        </p>

        <form id="checkForm">
          <div class="form-group">
            <label>학부모 연락처</label>
            <input
              type="tel"
              id="checkPhone"
              placeholder="010-0000-0000"
              required
            />
          </div>

          <div class="form-group">
            <label>비밀번호 (숫자 6자리)</label>
            <input
              type="password"
              id="checkPassword"
              class="password-input"
              placeholder="000000"
              pattern="[0-9]{6}"
              maxlength="6"
              required
            />
          </div>

          <button type="submit" class="btn btn-primary">예약 확인하기</button>
        </form>
      </div>

      <!-- 예약 조회 결과 -->
      <div id="result" class="card hidden">
        <button class="btn btn-back" onclick="showScreen('home')">
          ← 뒤로
        </button>
        <h2>예약 정보</h2>

        <div class="reservation-info" id="reservationInfo"></div>

        <div class="btn-group">
          <button
            class="btn btn-primary"
            style="background: #d32f2f"
            onclick="cancelReservation()"
          >
            예약 취소하기
          </button>
          <button class="btn btn-secondary" onclick="showScreen('home')">
            홈으로 돌아가기
          </button>
        </div>
      </div>
    </div>

    <!-- JavaScript 파일도 동적 버전 관리 -->
    <script>
      document.write(
        '<script src="assets/js/index.js?v=' +
          new Date().getTime() +
          '"><\/script>'
      );
    </script>
  </body>
</html>
