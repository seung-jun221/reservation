<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ìˆ˜í•™ì˜ ì•„ì¹¨ X i.study - ì§„ë‹¨ê²€ì‚¬ ì•ˆë‚´</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
        background-color: #f5f5f5;
        color: #333;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
      }

      .card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      h1 {
        font-size: 24px;
        text-align: center;
        margin-bottom: 10px;
        color: #1a73e8;
      }

      h2 {
        font-size: 20px;
        text-align: center;
        margin-bottom: 20px;
        color: #666;
      }

      h3 {
        font-size: 18px;
        margin-bottom: 15px;
        color: #333;
      }

      .info-box {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        font-size: 14px;
        line-height: 1.6;
      }

      .warning-box {
        background: #fff3cd;
        border: 1px solid #ffc107;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        font-size: 14px;
        line-height: 1.6;
      }

      .error-box {
        background: #ffebee;
        color: #c62828;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .btn-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .btn {
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        line-height: 1.4;
        width: 100%;
      }

      .btn-primary {
        background: #1a73e8;
        color: white;
      }

      .btn-primary:hover {
        background: #1557b0;
      }

      .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: white;
        color: #1a73e8;
        border: 2px solid #1a73e8;
      }

      .btn-secondary:hover {
        background: #e3f2fd;
      }

      .btn-success {
        background: #4caf50;
        color: white;
      }

      .btn-success:hover {
        background: #45a049;
      }

      .btn-back {
        background: #666;
        color: white;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #1a73e8;
      }

      /* ì‹œí—˜ì§€ ì„ íƒ ì¹´ë“œ */
      .test-selection-grid {
        display: grid;
        gap: 15px;
        margin-bottom: 20px;
      }

      .test-card {
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
      }

      .test-card:hover {
        border-color: #1a73e8;
        box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
      }

      .test-card.selected {
        border-color: #1a73e8;
        background: #f0f7ff;
      }

      .test-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .badge-recommended {
        background: #4caf50;
        color: white;
      }

      .badge-advanced {
        background: #ff6b35;
        color: white;
      }

      .badge-highest {
        background: #9c27b0;
        color: white;
      }

      .badge-high {
        background: #2196f3;
        color: white;
      }

      .test-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
      }

      .test-features {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      .feature-item {
        display: flex;
        align-items: center;
        margin: 8px 0;
        font-size: 14px;
      }

      .feature-icon {
        margin-right: 8px;
        font-size: 16px;
      }

      .check {
        color: #4caf50;
      }
      .warn {
        color: #ff9800;
      }
      .info {
        color: #2196f3;
      }

      /* HME í•™ë…„ ì„ íƒ */
      .grade-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin: 15px 0;
      }

      .grade-btn {
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
        text-align: center;
      }

      .grade-btn:hover {
        background: #e3f2fd;
        border-color: #1a73e8;
      }

      .grade-btn.selected {
        background: #1a73e8;
        color: white;
        border-color: #1a73e8;
      }

      /* ì²´í¬ë¦¬ìŠ¤íŠ¸ */
      .checklist {
        margin: 20px 0;
      }

      .checklist-item {
        display: flex;
        align-items: flex-start;
        margin: 12px 0;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 6px;
      }

      .checklist-item input[type='checkbox'] {
        width: auto;
        margin-right: 12px;
        margin-top: 2px;
      }

      .checklist-item label {
        margin: 0;
        font-weight: normal;
        flex: 1;
      }

      /* ìŠ¤í… ì¸ë””ì¼€ì´í„° */
      .step-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 30px;
      }

      .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e0e0e0;
        color: #999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
      }

      .step.active {
        background: #1a73e8;
        color: white;
      }

      .step.completed {
        background: #4caf50;
        color: white;
      }

      .step-line {
        width: 60px;
        height: 2px;
        background: #e0e0e0;
        margin: 0 10px;
      }

      .step-line.completed {
        background: #4caf50;
      }

      /* ì •ë³´ í‘œì‹œ */
      .info-display {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .info-item {
        display: flex;
        margin: 10px 0;
      }

      .info-label {
        font-weight: 600;
        color: #666;
        min-width: 100px;
        margin-right: 15px;
      }

      .info-value {
        color: #333;
      }

      /* ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ */
      .download-section {
        background: #f0f7ff;
        border: 2px solid #1a73e8;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        margin: 20px 0;
      }

      .download-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .download-btn {
        display: inline-block;
        padding: 15px 30px;
        background: #1a73e8;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
      }

      .download-btn:hover {
        background: #1557b0;
        transform: translateY(-2px);
      }

      .download-btn.solution {
        background: #4caf50;
      }

      .download-btn.solution:hover {
        background: #45a049;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #1a73e8;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none !important;
      }

      .divider {
        text-align: center;
        margin: 30px 0;
        position: relative;
      }

      .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #ddd;
      }

      .divider span {
        background: white;
        padding: 0 20px;
        position: relative;
        color: #999;
        font-size: 14px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .card {
          padding: 20px;
        }

        .grade-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .download-buttons {
          flex-direction: column;
        }

        .download-btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- í—¤ë” -->
      <div class="card">
        <h1>ìˆ˜í•™ì˜ ì•„ì¹¨ X i.study [ìˆ˜ë¦¬íƒêµ¬]</h1>
        <h2>ì§„ë‹¨ê²€ì‚¬ ì‘ì‹œ ì•ˆë‚´</h2>
        <div class="info-box">
          <p>
            ë³¸ ì§„ë‹¨ê²€ì‚¬ëŠ” í•™ìƒì˜ í˜„ì¬ ìˆ˜í•™ ì‹¤ë ¥ì„ ì •í™•íˆ ì§„ë‹¨í•˜ì—¬ ë§ì¶¤í˜• í•™ìŠµ
            ì„¤ê³„ë¥¼ ìœ„í•œ ìë£Œë¡œ í™œìš©ë©ë‹ˆë‹¤.
          </p>
          <br />
          <p>
            ì§„ë‹¨ê²€ì‚¬ ì™„ë£Œ í›„ ê°œë³„ ì»¨ì„¤íŒ…ì„ í†µí•´ ìƒì„¸í•œ ë¶„ì„ê³¼ í•™ìŠµ ë¡œë“œë§µì„
            ì œê³µí•´ë“œë¦½ë‹ˆë‹¤.
          </p>
        </div>
      </div>
      <!-- STEP 1: ë³¸ì¸ í™•ì¸ -->
      <div id="step1" class="card">
        <div class="step-indicator">
          <div class="step active">1</div>
          <div class="step-line"></div>
          <div class="step">2</div>
          <div class="step-line"></div>
          <div class="step">3</div>
        </div>

        <h3>ë³¸ì¸ í™•ì¸</h3>
        <p style="margin-bottom: 20px; color: #666">
          ì„¤ëª…íšŒ ì°¸ì„ í›„ ì§„ë‹¨ê²€ì‚¬ë¥¼ ì‹ ì²­í•˜ì‹  ë¶„ë§Œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </p>

        <form id="verifyForm" onsubmit="event.preventDefault(); verifyUser();">
          <div class="form-group">
            <label>í•™ë¶€ëª¨ ì—°ë½ì²˜</label>
            <input
              type="tel"
              id="phoneInput"
              placeholder="010-0000-0000"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">í™•ì¸</button>
        </form>

        <div class="divider">
          <span>ë˜ëŠ”</span>
        </div>

        <div style="text-align: center">
          <p style="color: #666; margin-bottom: 15px">
            ì§„ë‹¨ê²€ì‚¬ë¥¼ ì²˜ìŒ ì‹ ì²­í•˜ì‹œë‚˜ìš”?
          </p>
          <button class="btn btn-secondary" onclick="showNewForm()">
            ì‹ ê·œ ì‹ ì²­í•˜ê¸°
          </button>
        </div>
      </div>

      <!-- STEP 1-2: ì‹ ê·œ ì‹ ì²­ -->
      <div id="newForm" class="card hidden">
        <button class="btn btn-back" onclick="backToVerify()">â† ë’¤ë¡œ</button>
        <h3>ì§„ë‹¨ê²€ì‚¬ ì‹ ì²­</h3>
        <p style="margin-bottom: 20px; color: #666">
          ì •í™•í•œ ì§„ë‹¨ì„ ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
        </p>

        <form
          id="newApplicationForm"
          onsubmit="event.preventDefault(); submitNewApplication();"
        >
          <div class="form-group">
            <label>í•™ìƒëª…</label>
            <input type="text" id="newName" required />
          </div>

          <div class="form-group">
            <label>í•™ë¶€ëª¨ ì—°ë½ì²˜</label>
            <input
              type="tel"
              id="newPhone"
              placeholder="010-0000-0000"
              required
            />
          </div>

          <div class="form-group">
            <label>í•™êµ</label>
            <input type="text" id="newSchool" required />
          </div>

          <div class="form-group">
            <label>í•™ë…„</label>
            <select id="newGrade" required>
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option value="ì´ˆ1">ì´ˆë“±í•™êµ 1í•™ë…„</option>
              <option value="ì´ˆ2">ì´ˆë“±í•™êµ 2í•™ë…„</option>
              <option value="ì´ˆ3">ì´ˆë“±í•™êµ 3í•™ë…„</option>
              <option value="ì´ˆ4">ì´ˆë“±í•™êµ 4í•™ë…„</option>
              <option value="ì´ˆ5">ì´ˆë“±í•™êµ 5í•™ë…„</option>
              <option value="ì´ˆ6">ì´ˆë“±í•™êµ 6í•™ë…„</option>
              <option value="ì¤‘1">ì¤‘í•™êµ 1í•™ë…„</option>
              <option value="ì¤‘2">ì¤‘í•™êµ 2í•™ë…„</option>
              <option value="ì¤‘3">ì¤‘í•™êµ 3í•™ë…„</option>
              <option value="ê³ 1">ê³ ë“±í•™êµ 1í•™ë…„</option>
              <option value="ê³ 2">ê³ ë“±í•™êµ 2í•™ë…„</option>
              <option value="ê³ 3">ê³ ë“±í•™êµ 3í•™ë…„</option>
            </select>
          </div>

          <div class="form-group">
            <label>ìˆ˜í•™ ì„ í–‰ì •ë„</label>
            <input
              type="text"
              id="newMathLevel"
              placeholder="ì˜ˆ: ì¤‘2-1 ì‹¬í™” ì™„ë£Œ"
              required
            />
          </div>

          <button type="submit" class="btn btn-primary">ë‹¤ìŒ</button>
        </form>
      </div>

      <!-- STEP 2: ì •ë³´ í™•ì¸ -->
      <div id="step2Info" class="card hidden">
        <div class="step-indicator">
          <div class="step completed">âœ“</div>
          <div class="step-line completed"></div>
          <div class="step active">2</div>
          <div class="step-line"></div>
          <div class="step">3</div>
        </div>

        <h3>ì‹ ì²­ ì •ë³´ í™•ì¸</h3>

        <div class="info-display">
          <div class="info-item">
            <span class="info-label">í•™ìƒëª…:</span>
            <span class="info-value" id="confirmName">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">í•™êµ:</span>
            <span class="info-value" id="confirmSchool">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">í•™ë…„:</span>
            <span class="info-value" id="confirmGrade">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">ìˆ˜í•™ ì„ í–‰:</span>
            <span class="info-value" id="confirmMathLevel">-</span>
          </div>
        </div>

        <button class="btn btn-primary" onclick="showTestSelection()">
          ì‹œí—˜ì§€ ì„ íƒí•˜ê¸°
        </button>
      </div>

      <!-- STEP 2: ì‹œí—˜ì§€ ì„ íƒ -->
      <div id="step2" class="card hidden">
        <div class="step-indicator">
          <div class="step completed">âœ“</div>
          <div class="step-line completed"></div>
          <div class="step active">2</div>
          <div class="step-line"></div>
          <div class="step">3</div>
        </div>

        <h3>ì§„ë‹¨ê²€ì‚¬ ì„ íƒ</h3>
        <p style="margin-bottom: 20px; color: #666">
          í•™ìƒì˜ í˜„ì¬ ìˆ˜ì¤€ì— ë§ëŠ” ì‹œí—˜ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
        </p>

        <div class="warning-box">
          <h4 style="margin-bottom: 10px">
            âš ï¸ ìì²´ ì§„ë‹¨ê²€ì‚¬(MONO/TRI) ì„ íƒ ì‹œ ì£¼ì˜ì‚¬í•­
          </h4>
          <ul style="margin-left: 20px; font-size: 14px">
            <li>ì •ë‹µ ë° í’€ì´ì§‘ì´ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</li>
            <li>ì‘ì„±í•œ ì‹œí—˜ì§€ë¥¼ ì»¨ì„¤íŒ… ì‹œ ë°˜ë“œì‹œ ì§€ì°¸í•˜ì„¸ìš”</li>
            <li>í˜„ì¥ì—ì„œ ì±„ì  í›„ ì¦‰ì‹œ ë¶„ì„ ì§„í–‰</li>
          </ul>
        </div>

        <div class="test-selection-grid">
          <!-- HME í•™ë ¥í‰ê°€ -->
          <div class="test-card" onclick="selectTest('HME')">
            <span class="test-badge badge-recommended">ì¶”ì²œ</span>
            <div class="test-title">HME í•™ë ¥í‰ê°€</div>
            <div class="test-features">
              <div class="feature-item">
                <span class="feature-icon check">âœ…</span> ë‹µì•ˆì§€ ì œê³µ
              </div>
              <div class="feature-item">
                <span class="feature-icon check">âœ…</span> í’€ì´ì§‘ ì œê³µ
              </div>
              <div class="feature-item">
                <span class="feature-icon info">ğŸ“š</span> ëŒ€ìƒ: ì´ˆë“± ~ ì¤‘ë“± ê¸°ì´ˆ
              </div>
              <div class="feature-item">
                <span class="feature-icon info">ğŸ“</span> 9ì¢… ì‹œí—˜ì§€ (ì´ˆ1~ì¤‘3)
              </div>
            </div>
            <button class="btn btn-primary">HME ì„ íƒí•˜ê¸° â†’</button>
          </div>

          <!-- MONO ì§„ë‹¨ê²€ì‚¬ -->
          <div class="test-card" onclick="selectTest('MONO')">
            <span class="test-badge badge-advanced">ì‹¬í™”</span>
            <div class="test-title">MONO ì§„ë‹¨ê²€ì‚¬</div>
            <div class="test-features">
              <div class="feature-item">
                <span class="feature-icon warn">âš ï¸</span> ë‹µì•ˆì§€ ë¯¸ì œê³µ
              </div>
              <div class="feature-item">
                <span class="feature-icon warn">âš ï¸</span> í˜„ì¥ ì±„ì  í•„ìˆ˜
              </div>
              <div class="feature-item">
                <span class="feature-icon info">ğŸ“š</span> ëŒ€ìƒ: ì¤‘1-1 ì‹¬í™” ì™„ë£Œ
              </div>
              <div class="feature-item">
                <span class="feature-icon info">â±ï¸</span> 25ë¬¸í•­ / 90ë¶„
              </div>
            </div>
            <button class="btn btn-primary">MONO ì„ íƒí•˜ê¸° â†’</button>
          </div>

          <!-- TRI ì§„ë‹¨ê²€ì‚¬ -->
          <div class="test-card" onclick="selectTest('TRI')">
            <span class="test-badge badge-highest">ìµœìƒìœ„</span>
            <div class="test-title">TRI ì§„ë‹¨ê²€ì‚¬</div>
            <div class="test-features">
              <div class="feature-item">
                <span class="feature-icon warn">âš ï¸</span> ë‹µì•ˆì§€ ë¯¸ì œê³µ
              </div>
              <div class="feature-item">
                <span class="feature-icon warn">âš ï¸</span> ê³µí†µìˆ˜í•™1 í¬í•¨
              </div>
              <div class="feature-item">
                <span class="feature-icon info">ğŸ“š</span> ëŒ€ìƒ: ì¤‘3-1 ì‹¬í™” ì™„ë£Œ
              </div>
              <div class="feature-item">
                <span class="feature-icon info">â±ï¸</span> 25ë¬¸í•­ / 90ë¶„
              </div>
            </div>
            <button class="btn btn-primary">TRI ì„ íƒí•˜ê¸° â†’</button>
          </div>

          <!-- ê³ 1 ëª¨ì˜ê³ ì‚¬ -->
          <div class="test-card" onclick="selectTest('MOCK')">
            <span class="test-badge badge-high">ê³ ë“±</span>
            <div class="test-title">ê³ 1 6ì›” ëª¨ì˜ê³ ì‚¬</div>
            <div class="test-features">
              <div class="feature-item">
                <span class="feature-icon check">âœ…</span> ë‹µì•ˆì§€ ì œê³µ
              </div>
              <div class="feature-item">
                <span class="feature-icon check">âœ…</span> í•´ì„¤ì§€ ì œê³µ
              </div>
              <div class="feature-item">
                <span class="feature-icon info">ğŸ“š</span> ëŒ€ìƒ: ê³ 1 ê³¼ì • ì´ìƒ
              </div>
              <div class="feature-item">
                <span class="feature-icon info">ğŸ“Š</span> ë“±ê¸‰ ì‚°ì • ê°€ëŠ¥
              </div>
            </div>
            <button class="btn btn-primary">ëª¨ì˜ê³ ì‚¬ ì„ íƒí•˜ê¸° â†’</button>
          </div>
        </div>
      </div>

      <!-- HME í•™ë…„ ì„ íƒ -->
      <div id="hmeGradeSelect" class="card hidden">
        <button class="btn btn-back" onclick="backToTestSelect()">
          â† ë’¤ë¡œ
        </button>
        <h3>HME í•™ë ¥í‰ê°€ - í•™ë…„ ì„ íƒ</h3>
        <p style="margin-bottom: 20px; color: #666">
          ğŸ’¡ í˜„ì¬ í•™ë…„ë³´ë‹¤ 1~2í•™ë…„ ìœ„ë¥¼ ì„ íƒí•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
        </p>

        <div class="info-box">
          <strong>ì„ íƒ ê¸°ì¤€</strong>
          <ul style="margin-left: 20px; margin-top: 10px">
            <li>í˜„ì¬ í•™ë…„ë³´ë‹¤ ë†’ì€ ë‹¨ê³„ ì„ íƒ ê¶Œì¥</li>
            <li>ì„ í–‰ ì§„ë„ì— ë§ì¶° ì„ íƒ</li>
            <li>í™•ì‹¤í•˜ì§€ ì•Šìœ¼ë©´ ë‚®ì€ ë‹¨ê³„ë¶€í„° ì‹œì‘</li>
          </ul>
        </div>

        <h4 style="margin-bottom: 10px">ì´ˆë“±ë¶€</h4>
        <div class="grade-grid">
          <button class="grade-btn" onclick="selectHMEGrade('ì´ˆ1')">ì´ˆ1</button>
          <button class="grade-btn" onclick="selectHMEGrade('ì´ˆ2')">ì´ˆ2</button>
          <button class="grade-btn" onclick="selectHMEGrade('ì´ˆ3')">ì´ˆ3</button>
          <button class="grade-btn" onclick="selectHMEGrade('ì´ˆ4')">ì´ˆ4</button>
          <button class="grade-btn" onclick="selectHMEGrade('ì´ˆ5')">ì´ˆ5</button>
          <button class="grade-btn" onclick="selectHMEGrade('ì´ˆ6')">ì´ˆ6</button>
        </div>

        <h4 style="margin: 20px 0 10px">ì¤‘ë“±ë¶€</h4>
        <div class="grade-grid">
          <button class="grade-btn" onclick="selectHMEGrade('ì¤‘1')">ì¤‘1</button>
          <button class="grade-btn" onclick="selectHMEGrade('ì¤‘2')">ì¤‘2</button>
          <button class="grade-btn" onclick="selectHMEGrade('ì¤‘3')">ì¤‘3</button>
        </div>
      </div>

      <!-- STEP 3: ë‹¤ìš´ë¡œë“œ -->
      <div id="step3" class="card hidden">
        <div class="step-indicator">
          <div class="step completed">âœ“</div>
          <div class="step-line completed"></div>
          <div class="step completed">âœ“</div>
          <div class="step-line completed"></div>
          <div class="step active">3</div>
        </div>

        <h3>ì‹œí—˜ì§€ ë‹¤ìš´ë¡œë“œ</h3>

        <div class="info-display">
          <div class="info-item">
            <span class="info-label">ì„ íƒí•œ ì‹œí—˜:</span>
            <span class="info-value" id="selectedTestName">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">í•™ìƒëª…:</span>
            <span class="info-value" id="downloadStudentName">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">í•™ë…„:</span>
            <span class="info-value" id="downloadGrade">-</span>
          </div>
        </div>

        <!-- MONO/TRI ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
        <div id="proprietaryChecklist" class="hidden">
          <div class="warning-box">
            <h4 style="margin-bottom: 15px">ğŸ“Œ ì§„ë‹¨ê²€ì‚¬ ì‘ì‹œ ì•ˆë‚´</h4>
            <p style="font-size: 14px; line-height: 1.6; margin-bottom: 10px">
              ë³¸ ì§„ë‹¨ê²€ì‚¬ëŠ” ê³¼ì • ì„±ì·¨ë„ í™•ì¸ì´ ì•„ë‹Œ,
              <strong>ê³ ë“±ê³¼ì • ì§„í–‰ ì‹œ ì´í•´ë„ë¥¼ ì˜ˆì¸¡</strong>í•˜ëŠ” ê²€ì‚¬ì…ë‹ˆë‹¤.
              ìƒì†Œí•œ ë¬¸ì œë¼ë„ ëê¹Œì§€ ê³ ë¯¼í•´ë³´ì„¸ìš”.
            </p>
          </div>

          <h4 style="margin: 20px 0 15px">ì‘ì‹œ ì „ í™•ì¸ì‚¬í•­</h4>
          <div class="checklist">
            <div class="checklist-item">
              <input type="checkbox" id="check1" onchange="checkAllBoxes()" />
              <label for="check1">ë‹µì•ˆì§€ê°€ ì œê³µë˜ì§€ ì•ŠìŒì„ ì´í•´í–ˆìŠµë‹ˆë‹¤</label>
            </div>
            <div class="checklist-item">
              <input type="checkbox" id="check2" onchange="checkAllBoxes()" />
              <label for="check2"
                >ì‘ì„±í•œ ì‹œí—˜ì§€ë¥¼ ì»¨ì„¤íŒ… ì‹œ ì§€ì°¸í•´ì•¼ í•¨ì„ ì´í•´í–ˆìŠµë‹ˆë‹¤</label
              >
            </div>
            <div class="checklist-item">
              <input type="checkbox" id="check3" onchange="checkAllBoxes()" />
              <label for="check3">90ë¶„ ì‹œê°„ì œí•œì„ ì§€í‚¬ ê²ƒì„ ì•½ì†í•©ë‹ˆë‹¤</label>
            </div>
            <div class="checklist-item">
              <input type="checkbox" id="check4" onchange="checkAllBoxes()" />
              <label for="check4">ì™¸ë¶€ ë„ì›€ ì—†ì´ í˜¼ì í’€ ê²ƒì„ ì•½ì†í•©ë‹ˆë‹¤</label>
            </div>
          </div>
        </div>

        <div class="download-section">
          <h3 style="margin-bottom: 10px">ğŸ“¥ ì‹œí—˜ì§€ ë‹¤ìš´ë¡œë“œ</h3>
          <p style="color: #666; margin-bottom: 20px">
            ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‹œí—˜ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”
          </p>
          <div class="download-buttons">
            <a
              id="downloadLink"
              class="download-btn"
              href="#"
              download
              onclick="recordDownload()"
            >
              ğŸ“„ ì‹œí—˜ì§€ ë‹¤ìš´ë¡œë“œ
            </a>
            <a
              id="solutionLink"
              class="download-btn solution hidden"
              href="#"
              download
            >
              ğŸ“ í’€ì´ì§‘ ë‹¤ìš´ë¡œë“œ
            </a>
          </div>
        </div>

        <div class="info-box" style="margin-top: 30px">
          <h4 style="margin-bottom: 10px">âœ… ë‹¤ìŒ ë‹¨ê³„ ì•ˆë‚´</h4>
          <ol style="margin-left: 20px; line-height: 1.8">
            <li>ì§„ë‹¨ê²€ì‚¬ë¥¼ ì •í•´ì§„ ì‹œê°„ ë‚´ì— ì‘ì‹œí•©ë‹ˆë‹¤</li>
            <li>ì»¨ì„¤íŒ… ì˜ˆì•½ ë§í¬ê°€ ë¬¸ìë¡œ ë°œì†¡ë©ë‹ˆë‹¤</li>
            <li>ì»¨ì„¤íŒ… ì‹œ ì‘ì„±í•œ ì‹œí—˜ì§€ë¥¼ ì§€ì°¸í•©ë‹ˆë‹¤</li>
            <li>í˜„ì¥ì—ì„œ ì±„ì  ë° ë¶„ì„ì„ ì§„í–‰í•©ë‹ˆë‹¤</li>
          </ol>
        </div>
      </div>

      <!-- ë¡œë”© -->
      <div id="loading" class="card hidden">
        <div class="loading">
          <div class="spinner"></div>
          <p>ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
      </div>
    </div>

    <!-- Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      // Supabase ì„¤ì • (ì‹¤ì œ ê°’ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
      const SUPABASE_URL = 'https://xooglumwuzctbcjtcvnd.supabase.co';
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhvb2dsdW13dXpjdGJjanRjdm5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1OTk5OTgsImV4cCI6MjA3MTE3NTk5OH0.Uza-Z3CzwQgkYKJmKdwTNCAYgaxeKFs__2udUSAGpJg';

      // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” (ì¤‘ìš”!)
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // ì „ì—­ ë³€ìˆ˜
      let currentUser = null;
      let selectedTest = null;
      let selectedHMEGrade = null;

      // ì „í™”ë²ˆí˜¸ í¬ë§·
      function formatPhone(phone) {
        const cleaned = phone.replace(/\D/g, '');
        if (cleaned.length === 11) {
          return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
        } else if (cleaned.length === 10) {
          return cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
        }
        return phone;
      }

      // ê¸°ì¡´ ì‹ ì²­ì í™•ì¸ ì‹œ test_applicationsë„ ì²´í¬

      async function verifyUser() {
        const phone = document.getElementById('phoneInput').value;
        const cleanPhone = phone.replace(/\D/g, '');

        let formattedPhone;
        if (cleanPhone.length === 11) {
          formattedPhone = `${cleanPhone.slice(0, 3)}-${cleanPhone.slice(
            3,
            7
          )}-${cleanPhone.slice(7)}`;
        } else if (cleanPhone.length === 10) {
          formattedPhone = `010-${cleanPhone.slice(0, 4)}-${cleanPhone.slice(
            4
          )}`;
        } else {
          alert('ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
          return;
        }

        console.log('ì¡°íšŒí•  ì „í™”ë²ˆí˜¸:', formattedPhone);
        showLoading();

        try {
          // 1. ê¸°ì¡´ ë‹¤ìš´ë¡œë“œ ì´ë ¥ í™•ì¸
          const { data: existingTest, error: testError } = await supabase
            .from('test_applications')
            .select('*')
            .eq('parent_phone', formattedPhone)
            .order('created_at', { ascending: false })
            .limit(1);

          if (existingTest && existingTest.length > 0) {
            // ì´ë¯¸ ë‹¤ìš´ë¡œë“œí•œ ì´ë ¥ì´ ìˆìŒ
            hideLoading();
            const testInfo = existingTest[0];
            const downloadDate = new Date(
              testInfo.downloaded_at
            ).toLocaleDateString('ko-KR');

            if (
              confirm(
                `ğŸ“Œ ì´ë¯¸ ì§„ë‹¨ê²€ì‚¬ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì‹  ì´ë ¥ì´ ìˆìŠµë‹ˆë‹¤.\n\n` +
                  `í•™ìƒëª…: ${testInfo.student_name}\n` +
                  `ë‹¤ìš´ë¡œë“œ ë‚ ì§œ: ${downloadDate}\n` +
                  `ê²€ì‚¬ ìœ í˜•: ${testInfo.test_type}${
                    testInfo.hme_grade ? ` (${testInfo.hme_grade})` : ''
                  }\n\n` +
                  `ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
              )
            ) {
              // ê¸°ì¡´ ì •ë³´ë¡œ ì§„í–‰
              currentUser = {
                student_name: testInfo.student_name,
                parent_phone: testInfo.parent_phone,
                school: testInfo.school,
                grade: testInfo.grade,
                math_level: testInfo.math_level,
              };
              showInfoConfirm();
            }
            return;
          }

          // 2. ì„¤ëª…íšŒ ì²´í¬ì¸ í›„ ì§„ë‹¨ê²€ì‚¬ ì„ íƒì í™•ì¸
          const { data: testApplicant, error: reservationError } =
            await supabase
              .from('reservations')
              .select('*')
              .eq('parent_phone', formattedPhone)
              .eq('status', 'ì°¸ì„')
              .eq('post_checkin_choice', 'test')
              .order('id', { ascending: false })
              .limit(1);

          console.log('ì§„ë‹¨ê²€ì‚¬ ì‹ ì²­ì ì¡°íšŒ ê²°ê³¼:', testApplicant);

          // â­ ë””ë²„ê¹…: ì‹¤ì œ í•„ë“œ í™•ì¸
          if (testApplicant && testApplicant.length > 0) {
            console.log('=== reservations í…Œì´ë¸” í•„ë“œ í™•ì¸ ===');
            console.log('ì „ì²´ ë°ì´í„°:', testApplicant[0]);
            console.log('student_name:', testApplicant[0].student_name);
            console.log('name:', testApplicant[0].name);
            console.log('reservation_id:', testApplicant[0].reservation_id);

            // â­ í•„ë“œëª… ìë™ ê°ì§€ ë° ë§¤í•‘
            const record = testApplicant[0];
            const studentName =
              record.student_name ||
              record.name ||
              record.reservation_id ||
              'ë¯¸ì…ë ¥';

            currentUser = {
              student_name: studentName, // ìœ ì—°í•œ í•„ë“œ ë§¤í•‘
              parent_phone: record.parent_phone,
              school: record.school || 'ë¯¸ì…ë ¥',
              grade: record.grade || 'ë¯¸ì…ë ¥',
              math_level: record.math_level || 'ë¯¸ì…ë ¥',
            };

            console.log('ìƒì„±ëœ currentUser:', currentUser);
            hideLoading();
            showInfoConfirm();
            return;
          }

          // 3. ê·¸ ì™¸ ëª¨ë“  ê²½ìš° - ì‹ ê·œ ì‹ ì²­ ì•ˆë‚´
          hideLoading();
          alert(
            'ì§„ë‹¨ê²€ì‚¬ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.\n\n' +
              'í™”ë©´ í•˜ë‹¨ì˜ [ì‹ ê·œ ì‹ ì²­í•˜ê¸°]ë¥¼ í†µí•´ ì§„í–‰í•´ì£¼ì„¸ìš”.'
          );
        } catch (error) {
          console.error('Error:', error);
          hideLoading();
          alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }

      // ì§„ë‹¨ê²€ì‚¬ ì„ íƒìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ ì¶”ê°€
      async function updateToTestChoice(reservationId) {
        try {
          const { error } = await supabase
            .from('reservations')
            .update({
              post_checkin_choice: 'test',
              post_checkin_at: new Date().toISOString(),
            })
            .eq('id', reservationId);

          if (!error) {
            console.log('ì§„ë‹¨ê²€ì‚¬ ì„ íƒ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
          }
        } catch (error) {
          console.error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        }
      }

      // ì‹ ê·œ ì‹ ì²­ í¼ í‘œì‹œ
      function showNewForm() {
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('newForm').classList.remove('hidden');
      }

      // ì‹ ê·œ ì‹ ì²­ ì œì¶œ
      async function submitNewApplication() {
        const phone = document.getElementById('newPhone').value;
        const cleanPhone = phone.replace(/\D/g, '');

        // í•˜ì´í”ˆ í¬í•¨ í˜•ì‹ìœ¼ë¡œ ì €ì¥
        let formattedPhone;
        if (cleanPhone.length === 11) {
          formattedPhone = `${cleanPhone.slice(0, 3)}-${cleanPhone.slice(
            3,
            7
          )}-${cleanPhone.slice(7)}`;
        } else {
          formattedPhone = `010-${cleanPhone.slice(0, 4)}-${cleanPhone.slice(
            4
          )}`;
        }

        const data = {
          student_name: document.getElementById('newName').value.trim(),
          parent_phone: formattedPhone, // í•˜ì´í”ˆ í¬í•¨ í˜•ì‹ìœ¼ë¡œ ì €ì¥
          school: document.getElementById('newSchool').value.trim(),
          grade: document.getElementById('newGrade').value,
          math_level: document.getElementById('newMathLevel').value.trim(),
        };

        if (
          !data.student_name ||
          !data.parent_phone ||
          !data.school ||
          !data.grade ||
          !data.math_level
        ) {
          alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
          return;
        }

        showLoading();

        try {
          // TODO: ì‹¤ì œ Supabase ì €ì¥ìœ¼ë¡œ ë³€ê²½
          // const { data: savedData, error } = await supabase
          //     .from('test_applications')
          //     .insert([data])
          //     .single();

          // ì„ì‹œë¡œ localStorageì— ì €ì¥
          localStorage.setItem(
            `user_${data.parent_phone}`,
            JSON.stringify(data)
          );
          currentUser = data;

          hideLoading();
          showInfoConfirm();
        } catch (error) {
          console.error('Error:', error);
          hideLoading();
          alert('ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // ì •ë³´ í™•ì¸ í™”ë©´ í‘œì‹œ
      function showInfoConfirm() {
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('newForm').classList.add('hidden');
        document.getElementById('step2Info').classList.remove('hidden');

        // ì •ë³´ í‘œì‹œ
        document.getElementById('confirmName').textContent =
          currentUser.student_name;
        document.getElementById('confirmSchool').textContent =
          currentUser.school;
        document.getElementById('confirmGrade').textContent = currentUser.grade;
        document.getElementById('confirmMathLevel').textContent =
          currentUser.math_level;
      }

      // ì‹œí—˜ì§€ ì„ íƒ í™”ë©´ í‘œì‹œ
      function showTestSelection() {
        document.getElementById('step2Info').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');
      }

      // ì‹œí—˜ì§€ ì„ íƒ
      function selectTest(type) {
        selectedTest = type;

        if (type === 'HME') {
          document.getElementById('step2').classList.add('hidden');
          document.getElementById('hmeGradeSelect').classList.remove('hidden');
        } else {
          showDownloadPage();
        }
      }

      // HME í•™ë…„ ì„ íƒ
      function selectHMEGrade(grade) {
        selectedHMEGrade = grade;

        // ì„ íƒ í‘œì‹œ
        document.querySelectorAll('.grade-btn').forEach((btn) => {
          btn.classList.remove('selected');
          if (btn.textContent === grade) {
            btn.classList.add('selected');
          }
        });

        // ì ì‹œ í›„ ë‹¤ìš´ë¡œë“œ í˜ì´ì§€ë¡œ ì´ë™
        setTimeout(() => {
          showDownloadPage();
        }, 300);
      }

      // ë‹¤ìš´ë¡œë“œ í˜ì´ì§€ í‘œì‹œ
      function showDownloadPage() {
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('hmeGradeSelect').classList.add('hidden');
        document.getElementById('step3').classList.remove('hidden');

        // ì„ íƒ ì •ë³´ í‘œì‹œ
        let testName = '';
        if (selectedTest === 'HME') {
          testName = `HME í•™ë ¥í‰ê°€ - ${selectedHMEGrade}`;
        } else if (selectedTest === 'MONO') {
          testName = 'MONO ì§„ë‹¨ê²€ì‚¬';
        } else if (selectedTest === 'TRI') {
          testName = 'TRI ì§„ë‹¨ê²€ì‚¬';
        } else if (selectedTest === 'MOCK') {
          testName = 'ê³ 1 6ì›” ëª¨ì˜ê³ ì‚¬';
        }

        document.getElementById('selectedTestName').textContent = testName;
        document.getElementById('downloadStudentName').textContent =
          currentUser?.student_name || '-';
        document.getElementById('downloadGrade').textContent =
          currentUser?.grade || '-';

        // MONO/TRI ì²´í¬ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
        if (selectedTest === 'MONO' || selectedTest === 'TRI') {
          document
            .getElementById('proprietaryChecklist')
            .classList.remove('hidden');
          document.getElementById('downloadLink').style.display = 'none';
        } else {
          document
            .getElementById('proprietaryChecklist')
            .classList.add('hidden');
          document.getElementById('downloadLink').style.display =
            'inline-block';
        }

        // ë‹¤ìš´ë¡œë“œ ë§í¬ ì„¤ì • (ì‹¤ì œ PDF ê²½ë¡œë¡œ ë³€ê²½ í•„ìš”)
        const downloadLink = document.getElementById('downloadLink');
        const solutionLink = document.getElementById('solutionLink');

        if (selectedTest === 'HME') {
          downloadLink.href = `/pdfs/HME_${selectedHMEGrade}.pdf`;
          solutionLink.href = `/pdfs/HME_${selectedHMEGrade}_solution.pdf`;
          solutionLink.classList.remove('hidden');
        } else if (selectedTest === 'MONO') {
          downloadLink.href = '/pdfs/MONO.pdf';
          solutionLink.classList.add('hidden');
        } else if (selectedTest === 'TRI') {
          downloadLink.href = '/pdfs/TRI.pdf';
          solutionLink.classList.add('hidden');
        } else if (selectedTest === 'MOCK') {
          downloadLink.href = '/pdfs/ê³ 1_6ì›”_ëª¨ì˜ê³ ì‚¬.pdf';
          solutionLink.href = '/pdfs/ê³ 1_6ì›”_ëª¨ì˜ê³ ì‚¬_í•´ì„¤.pdf';
          solutionLink.classList.remove('hidden');
        }
      }

      // ì²´í¬ë°•ìŠ¤ í™•ì¸
      function checkAllBoxes() {
        const checkboxes = document.querySelectorAll(
          '#proprietaryChecklist input[type="checkbox"]'
        );
        const allChecked = Array.from(checkboxes).every((cb) => cb.checked);

        const downloadLink = document.getElementById('downloadLink');
        if (allChecked) {
          downloadLink.style.display = 'inline-block';
        } else {
          downloadLink.style.display = 'none';
        }
      }

      // ë‹¤ìš´ë¡œë“œ ê¸°ë¡
      async function recordDownload() {
        try {
          console.log('=== ë‹¤ìš´ë¡œë“œ ê¸°ë¡ ì‹œì‘ ===');

          // currentUser ê²€ì¦ ë° í•„ë“œ ë§¤í•‘
          if (!currentUser) {
            alert('ì‹œí—˜ì§€ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            return;
          }

          // í•„ë“œëª… ìˆ˜ì •
          if (!currentUser.student_name) {
            if (currentUser.reservation_id) {
              currentUser.student_name = currentUser.reservation_id;
              delete currentUser.reservation_id;
            } else if (currentUser.name) {
              currentUser.student_name = currentUser.name;
              delete currentUser.name;
            }
          }

          // â­ ê¸°ì¡´ ë ˆì½”ë“œ í™•ì¸
          const { data: existing } = await supabase
            .from('test_applications')
            .select('*')
            .eq('parent_phone', currentUser.parent_phone)
            .is('downloaded_at', null)
            .single();

          // â­ í•œêµ­ ì‹œê°„ ê³„ì‚°
          const kstOffset = 9 * 60 * 60 * 1000;
          const kstTime = new Date(Date.now() + kstOffset);
          const downloadTime = kstTime.toISOString().replace('Z', '+09:00');

          if (existing) {
            // ê¸°ì¡´ ë ˆì½”ë“œ UPDATE (ì²´í¬ì¸ ì‹œ ì´ë¯¸ ìƒì„±ëœ ê²½ìš°)
            const { data, error } = await supabase
              .from('test_applications')
              .update({
                test_type: selectedTest,
                downloaded_at: downloadTime,
                hme_grade: selectedTest === 'HME' ? selectedHMEGrade : null,
              })
              .eq('id', existing.id)
              .select();

            if (error) throw error;
            console.log('âœ… ë‹¤ìš´ë¡œë“œ ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
          } else {
            // ì‹ ê·œ INSERT (ì²´í¬ì¸ ì—†ì´ ë°”ë¡œ ë‹¤ìš´ë¡œë“œ)
            const testData = {
              student_name: currentUser.student_name,
              parent_phone: currentUser.parent_phone,
              school: currentUser.school || 'ë¯¸ì…ë ¥',
              grade: currentUser.grade || 'ë¯¸ì…ë ¥',
              math_level: currentUser.math_level || 'ë¯¸ì…ë ¥',
              test_type: selectedTest,
              downloaded_at: downloadTime,
            };

            if (selectedTest === 'HME' && selectedHMEGrade) {
              testData.hme_grade = selectedHMEGrade;
            }

            const { data, error } = await supabase
              .from('test_applications')
              .insert([testData])
              .select();

            if (error) throw error;
            console.log('âœ… ì‹ ê·œ ê¸°ë¡ ì €ì¥ ì™„ë£Œ');
          }

          // ì„±ê³µ ì•Œë¦¼
          setTimeout(() => {
            alert(
              'âœ… ì‹œí—˜ì§€ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n' +
                `ğŸ“ ê²€ì‚¬ ìœ í˜•: ${selectedTest}${
                  selectedHMEGrade ? ` (${selectedHMEGrade})` : ''
                }\n` +
                `ğŸ‘¤ í•™ìƒëª…: ${currentUser.student_name}\n` +
                `ğŸ« í•™êµ: ${currentUser.school} ${currentUser.grade}\n\n` +
                'ğŸ“§ ì»¨ì„¤íŒ… ì˜ˆì•½ ë§í¬ëŠ” ì¶”í›„ ë¬¸ìë¡œ ë°œì†¡ë©ë‹ˆë‹¤.'
            );
          }, 500);
        } catch (error) {
          console.error('âŒ ì˜¤ë¥˜:', error);
          alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
        }
      }
      // reservations í…Œì´ë¸” ì—…ë°ì´íŠ¸ í—¬í¼ í•¨ìˆ˜ (ëŒ€ì²´ ìˆ˜ë‹¨ìœ¼ë¡œë§Œ ì‚¬ìš©)
      async function updateReservationRecord(isFailback = false) {
        if (!isFailback) {
          console.log('ğŸ“Œ test_applications ì„±ê³µ - reservations ì—…ë°ì´íŠ¸ ìŠ¤í‚µ');
          return;
        }

        try {
          const phone = currentUser.parent_phone;
          // ê¸°ì¡´ ë°ì´í„° ë¨¼ì € ì¡°íšŒ (memo ë³´ì¡´ì„ ìœ„í•´)
          const { data: reservations } = await supabase
            .from('reservations')
            .select('id, memo, notes') // ê¸°ì¡´ memo, notes ê°€ì ¸ì˜¤ê¸°
            .or(
              `parent_phone.eq.${phone},parent_phone.eq.${phone.replace(
                /-/g,
                ''
              )}`
            )
            .eq('post_checkin_choice', 'test')
            .order('id', { ascending: false })
            .limit(1);

          if (reservations && reservations.length > 0) {
            const reservation = reservations[0];
            const downloadInfo = `${selectedTest}${
              selectedHMEGrade ? `-${selectedHMEGrade}` : ''
            } / ${new Date().toLocaleString('ko-KR')}`;

            // ê¸°ì¡´ ë©”ëª¨ê°€ ìˆìœ¼ë©´ ì¶”ê°€, ì—†ìœ¼ë©´ ìƒˆë¡œ ì‘ì„±
            const updatedMemo = reservation.memo
              ? `${reservation.memo} | ì§„ë‹¨ê²€ì‚¬: ${selectedTest}`
              : `ì§„ë‹¨ê²€ì‚¬: ${selectedTest}`;

            // notesë„ ê¸°ì¡´ ë‚´ìš©ì— ì¶”ê°€
            const updatedNotes = reservation.notes
              ? `${reservation.notes}\nì§„ë‹¨ê²€ì‚¬ ë‹¤ìš´ë¡œë“œ: ${downloadInfo}`
              : `ì§„ë‹¨ê²€ì‚¬ ë‹¤ìš´ë¡œë“œ: ${downloadInfo}`;

            const { error } = await supabase
              .from('reservations')
              .update({
                memo: updatedMemo,
                notes: updatedNotes,
              })
              .eq('id', reservation.id);

            if (!error) {
              console.log('âœ… reservations í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ (ëŒ€ì²´ ê¸°ë¡)');
            }
          }
        } catch (e) {
          console.log('reservations ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
        }
      }

      // ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜
      function backToVerify() {
        document.getElementById('newForm').classList.add('hidden');
        document.getElementById('step1').classList.remove('hidden');
      }

      function backToTestSelect() {
        document.getElementById('hmeGradeSelect').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');
      }

      // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
      function showLoading() {
        document.getElementById('loading').classList.remove('hidden');
      }

      function hideLoading() {
        document.getElementById('loading').classList.add('hidden');
      }
    </script>
  </body>
</html>
